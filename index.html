<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Medak Officers’ Performance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Plotly.js v2 CDN -->
  <script src="https://cdn.plot.ly/plotly-2.35.3.min.js"></script>
  <style>
    body { font-family: system-ui, Segoe UI, Arial, sans-serif; margin: 0; background: #f7f8fa; color: #111; }
    header { background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: #fff; padding: 16px 20px; }
    header h1 { margin: 0; font-size: 22px; font-weight: 700; }
    header p { margin: 6px 0 0; font-size: 13px; opacity: 0.88;}
    .container { padding: 18px; max-width: 1400px; margin: 0 auto; }
    .filters { display: grid; gap: 12px; grid-template-columns: repeat(6, minmax(160px, 1fr)); background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; position: sticky; top: 0; z-index: 2; }
    .filters label { font-size: 13px; color: #374151; margin-bottom: 3.5px; display: block; }
    .filters input, .filters select, .filters button { width: 100%; padding: 8px; font-size: 13px; border: 1px solid #d1d5db; border-radius: 8px; }
    .filters button { background: #2563eb; color: #fff; border: none; cursor: pointer; }
    .filters button.secondary { background: #6b7280; }
    .kpis { display: grid; gap: 12px; grid-template-columns: repeat(5, 1fr); margin-top: 18px; }
    .kpi { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; }
    .kpi .label { font-size: 12px; color: #6b7280; }
    .kpi .value { font-size: 22px; font-weight: 700; margin-top: 7px; }
    .grid { display: grid; gap: 13px; grid-template-columns: 1fr 1fr; margin-top: 13px; }
    .full { grid-column: 1 / -1; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; }
    .card h3 { margin: 0 0 9px; font-size: 15px; }
    .footer { color: #6b7280; font-size: 12px; text-align: center; padding: 16px; }
    @media (max-width: 1000px) {
      .filters { grid-template-columns: repeat(2, minmax(160px, 1fr)); }
      .kpis { grid-template-columns: repeat(2, 1fr); }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Medak District Officers’ Performance Dashboard</h1>
    <p>Live: All data via Google Sheets tab <b>Form Responses 1</b>. If map doesn’t show, add Latitude/Longitude columns!</p>
  </header>

  <div class="container">
    <!-- Filters -->
    <div class="filters">
      <div>
        <label for="fromDate">From date</label>
        <input type="date" id="fromDate" />
      </div>
      <div>
        <label for="toDate">To date</label>
        <input type="date" id="toDate" />
      </div>
      <div>
        <label for="officer">Officer</label>
        <select id="officer" multiple size="5"></select>
      </div>
      <div>
        <label for="department">Department</label>
        <select id="department" multiple size="5"></select>
      </div>
      <div>
        <label for="mandal">Mandal</label>
        <select id="mandal" multiple size="5"></select>
      </div>
      <div>
        <label for="panchayat">Panchayat</label>
        <select id="panchayat" multiple size="5"></select>
      </div>
      <div>
        <label for="purpose">Purpose</label>
        <select id="purpose" multiple size="5"></select>
      </div>
      <div>
        <label for="followup">Follow-up Contains</label>
        <input type="text" id="followup" placeholder="e.g., replaced, escalated" />
      </div>
      <div>
        <label for="searchText">Keyword (Observations)</label>
        <input type="text" id="searchText" placeholder="e.g., VC, troubleshoot" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="applyBtn">Apply Filters</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="resetBtn" class="secondary">Reset</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><div class="label">Total Tours</div><div class="value" id="kpiTotal">-</div></div>
      <div class="kpi"><div class="label">Avg Duration</div><div class="value" id="kpiAvgDur">-</div></div>
      <div class="kpi"><div class="label">% With Attachments</div><div class="value" id="kpiAttach">-</div></div>
      <div class="kpi"><div class="label">Distinct Panchayats</div><div class="value" id="kpiPanch">-</div></div>
      <div class="kpi"><div class="label">Distinct Mandals</div><div class="value" id="kpiMandal">-</div></div>
    </div>

    <!-- Charts -->
    <div class="grid">
      <div class="card" id="mapCard" style="height:520px;">
        <h3>Medak Live Map: Visits by Mandal/Panchayat</h3>
        <div id="map" style="width:100%;height:460px;"></div>
      </div>

      <div class="card" style="height:520px;">
        <h3>Officer Performance (Visits)</h3>
        <div id="officerBar" style="width:100%;height:460px;"></div>
      </div>

      <div class="card">
        <h3>Departments by Visits</h3>
        <div id="deptBar" style="width:100%;height:360px;"></div>
      </div>

      <div class="card">
        <h3>Purpose of Visits</h3>
        <div id="purposePie" style="width:100%;height:360px;"></div>
      </div>

      <div class="card">
        <h3>Visit Duration by Officer</h3>
        <div id="durationBox" style="width:100%;height:360px;"></div>
      </div>

      <div class="card">
        <h3>Frequent Issues (from Observations)</h3>
        <div id="issuesBar" style="width:100%;height:360px;"></div>
      </div>

      <div class="card full">
        <h3>Trends Over Time: Visits & Follow-ups</h3>
        <div id="trendLine" style="width:100%;height:420px;"></div>
      </div>
    </div>

    <div class="footer">
      GitHub static hosting, Google Sheets API. Works with “Form Responses 1” tab. Last refreshed <span id="lastRefreshed">-</span>.
    </div>
  </div>

  <script>
    // Google Sheets config
    const SHEET_ID = "1JTtApnz0YUBocOEsVaPeNgtegO8A2fJoJqRDh38UHgo";
    const API_KEY = "AIzaSyANuZBwPyDawHhfzA2uXvWZH2k6b38mzXM";
    const TAB_NAME = "Form Responses 1";
    const RANGE = `${TAB_NAME}!A1:AZ100000`;

    // Columns mapping
    const FIELDS = {
      timestamp: ["Timestamp"], email: ["Email Address","Email"], officer: ["Name of the Officer","Officer Name","Officer"],
      department: ["Department"], designation: ["Designation"], contact: ["Contact Number","Phone","Mobile"],
      start: ["Tour Start Date & Time","Start","Start Time"], end: ["Tour End Date & Time","End","End Time"],
      mandal: ["Mandal Name","Mandal"], panchayat: ["Panchayat Name","Panchayat"], purpose: ["Purpose of Visit","Purpose"],
      observations: ["Key observations/Outcomes","Observations","Outcomes","Findings"], followup: ["Follow-up Actions Required","Follow up","Follow-up"],
      hierarchy: ["Level of hierarchy","Hierarchy"], attachments: ["Attachments","Attachment","Photo URL"], lat: ["Latitude","Lat"], lon: ["Longitude","Lon","Lng"]
    };

    function parseDateFlexible(s) {
      if (!s) return null;
      const tryDate = new Date(s);
      if (!isNaN(tryDate)) return tryDate;
      const t = String(s).trim().replace(/\./g, ":").replace(/\//g, "-");
      let m = t.match(/^(\d{1,2})-(\d{1,2})-(\d{4})\s+(\d{1,2}):(\d{2})$/);
      if (m) { const [, d, mo, y, hh, mm] = m; return new Date(Number(y), Number(mo)-1, Number(d), Number(hh), Number(mm)); }
      m = t.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
      if (m) { const [, d, mo, y] = m; return new Date(Number(y), Number(mo)-1, Number(d)); }
      return null;
    }
    function minutesBetween(a, b) { return !a || !b ? null : Math.round((b-a)/60000); }
    function pick(obj, keysArr) { for (const k of keysArr) { if (obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k]; } return ""; }
    function toSet(values) { return Array.from(new Set(values.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b))); }
    // Tokenizer for issues
    function tokenizeIssues(text) {
      if (!text) return [];
      const STOPWORDS = new Set(["with","from","that","this","have","need","needs","will","should","there","were","been","into","over","under","they","them","then","than","also","such","very","much","many","about","after","before","where","which","when","what","your","their","ours","ourselves","hers","himself","herself","itself","within","issue","issues","visit","visited","troubleshoot","action","actions","required","informed","state","team"]);
      return String(text).toLowerCase().replace(/[^a-z0-9\s]/g, " ").split(/\s+/).filter(w => w.length >= 4 && !STOPWORDS.has(w));
    }
    // State
    let rows = [], filtered = [];
    // Fetch function
    async function fetchSheet() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(RANGE)}?key=${API_KEY}`;
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status} on "${RANGE}"`);
        const data = await res.json();
        const values = data.values || [];
        if (values.length < 2) return [];
        const headers = values[0].map(h => (h || "").trim());
        return values.slice(1).map(r => {
          const obj = {}; headers.forEach((h, i) => obj[h] = (r[i] ?? "").trim()); return obj;
        });
      } catch (err) {
        alert("Google Sheets fetch failed. Check sharing, tab name, API key. Details: " + err);
        return [];
      }
    }

    function normalize(records) {
      return records.map(r => {
        const rec = {
          timestamp: pick(r, FIELDS.timestamp),
          email: pick(r, FIELDS.email),
          officer: pick(r, FIELDS.officer),
          department: pick(r, FIELDS.department),
          designation: pick(r, FIELDS.designation),
          contact: pick(r, FIELDS.contact),
          startRaw: pick(r, FIELDS.start),
          endRaw: pick(r, FIELDS.end),
          mandal: pick(r, FIELDS.mandal),
          panchayat: pick(r, FIELDS.panchayat),
          purpose: pick(r, FIELDS.purpose),
          observations: pick(r, FIELDS.observations),
          followup: pick(r, FIELDS.followup),
          hierarchy: pick(r, FIELDS.hierarchy),
          attachments: pick(r, FIELDS.attachments),
          lat: pick(r, FIELDS.lat),
          lon: pick(r, FIELDS.lon)
        };
        rec.start = parseDateFlexible(rec.startRaw);
        rec.end = parseDateFlexible(rec.endRaw);
        rec.durationMin = minutesBetween(rec.start, rec.end);
        rec.hasAttachment = !!(rec.attachments && rec.attachments.length > 0);
        rec.lat = (rec.lat && !isNaN(Number(rec.lat))) ? Number(rec.lat) : null;
        rec.lon = (rec.lon && !isNaN(Number(rec.lon))) ? Number(rec.lon) : null;
        return rec;
      });
    }

    function populateFilters(list) {
      const officerSel = document.getElementById("officer");
      const deptSel = document.getElementById("department");
      const mandalSel = document.getElementById("mandal");
      const panchSel = document.getElementById("panchayat");
      const purposeSel = document.getElementById("purpose");
      function fillSelect(el, arr) {
        el.innerHTML = "";
        toSet(arr).forEach(v => { const opt = document.createElement("option"); opt.value = v; opt.textContent = v; el.appendChild(opt); });
      }
      fillSelect(officerSel, list.map(x => x.officer));
      fillSelect(deptSel, list.map(x => x.department));
      fillSelect(mandalSel, list.map(x => x.mandal));
      fillSelect(panchSel, list.map(x => x.panchayat));
      fillSelect(purposeSel, list.map(x => x.purpose));
      // Set default date range
      const starts = list.map(x => x.start).filter(Boolean).sort((a,b)=>a-b);
      const minD = starts[0], maxD = starts[starts.length-1];
      if (minD) document.getElementById("fromDate").valueAsDate = minD;
      if (maxD) document.getElementById("toDate").valueAsDate = maxD;
    }

    function getMultiSelectValues(el) { return Array.from(el.selectedOptions).map(o => o.value); }
    function applyFilters() {
      const fromD = document.getElementById("fromDate").value ? new Date(document.getElementById("fromDate").value) : null;
      const toD = document.getElementById("toDate").value ? new Date(document.getElementById("toDate").value) : null;
      if (toD) toD.setHours(23,59,59,999);
      const selOfficer = getMultiSelectValues(document.getElementById("officer"));
      const selDept = getMultiSelectValues(document.getElementById("department"));
      const selMandal = getMultiSelectValues(document.getElementById("mandal"));
      const selPanch = getMultiSelectValues(document.getElementById("panchayat"));
      const selPurpose = getMultiSelectValues(document.getElementById("purpose"));
      const followupText = document.getElementById("followup").value.trim().toLowerCase();
      const searchText = document.getElementById("searchText").value.trim().toLowerCase();
      filtered = rows.filter(r => {
        if (fromD && r.start && r.start < fromD) return false;
        if (toD && r.start && r.start > toD) return false;
        if (selOfficer.length && !selOfficer.includes(r.officer)) return false;
        if (selDept.length && !selDept.includes(r.department)) return false;
        if (selMandal.length && !selMandal.includes(r.mandal)) return false;
        if (selPanch.length && !selPanch.includes(r.panchayat)) return false;
        if (selPurpose.length && !selPurpose.includes(r.purpose)) return false;
        if (followupText && !String(r.followup||"").toLowerCase().includes(followupText)) return false;
        if (searchText && !String(r.observations||"").toLowerCase().includes(searchText)) return false;
        return true;
      });
      renderAll();
    }

    function resetFilters() {
      document.getElementById("fromDate").value = "";
      document.getElementById("toDate").value = "";
      ["officer","department","mandal","panchayat","purpose"].forEach(id => {
        const el = document.getElementById(id);
        Array.from(el.options).forEach(o => o.selected = false);
      });
      document.getElementById("followup").value = "";
      document.getElementById("searchText").value = "";
      filtered = rows.slice();
      renderAll();
    }

    function fmtMins(min) { if (min == null || isNaN(min)) return "-"; const h = Math.floor(min/60), m = min%60; return h>0 ?`${h}h ${m}m`:`${m}m`; }
    function updateKPIs(list) {
      const total = list.length;
      const durationVals = list.map(x => x.durationMin || 0).filter(x=>x>0);
      const avg = durationVals.length ? Math.round(durationVals.reduce((a,b)=>a+b,0) / durationVals.length) : 0;
      const withAttach = list.filter(x => x.hasAttachment).length;
      const panch = toSet(list.map(x => x.panchayat)).length;
      const mandal = toSet(list.map(x => x.mandal)).length;
      document.getElementById("kpiTotal").textContent = total.toLocaleString();
      document.getElementById("kpiAvgDur").textContent = fmtMins(avg);
      document.getElementById("kpiAttach").textContent = (total ? Math.round(100*withAttach/total) : 0) + "%";
      document.getElementById("kpiPanch").textContent = panch.toLocaleString();
      document.getElementById("kpiMandal").textContent = mandal.toLocaleString();
      document.getElementById("lastRefreshed").textContent = new Date().toLocaleString();
    }

    // Chart helpers
    function groupCount(list, key) {
      const map = new Map();
      for (const r of list) { const k = (r[key] || "Unknown"); map.set(k, (map.get(k)||0)+1); }
      return Array.from(map, ([k,v]) => ({k,v})).sort((a,b)=>b.v-a.v);
    }
    function renderOfficerBar(list) {
      const data = groupCount(list, "officer").slice(0, 20);
      Plotly.newPlot("officerBar", [{type:"bar",x:data.map(d=>d.k),y:data.map(d=>d.v),marker:{color:"#1f77b4"}}],
        {margin:{l:40,r:10,t:10,b:80},xaxis:{automargin:true, tickangle:-30, title:"Officer"},yaxis:{title:"Visits"},displayModeBar:false},{responsive:true});
    }
    function renderDeptBar(list) {
      const data = groupCount(list, "department");
      Plotly.newPlot("deptBar", [{type:"bar",x:data.map(d=>d.k),y:data.map(d=>d.v),marker:{color:"#10b981"}}],
        {margin:{l:40,r:10,t:10,b:80},xaxis:{automargin:true, tickangle:-30, title:"Department"},yaxis:{title:"Visits"},displayModeBar:false}, {responsive:true});
    }
    function renderPurposePie(list) {
      const data = groupCount(list, "purpose");
      Plotly.newPlot("purposePie", [{type:"pie",labels:data.map(d=>d.k),values:data.map(d=>d.v), textinfo:"label+percent", hole:0.45}],
        {margin:{l:10,r:10,t:10,b:10},showlegend:true,displayModeBar:false},{responsive:true});
    }
    function renderDurationBox(list) {
      const byOfficer = new Map();
      for (const r of list) { if (r.durationMin!=null) { const k=r.officer||"Unknown"; if (!byOfficer.has(k)) byOfficer.set(k,[]); byOfficer.get(k).push(r.durationMin); } }
      const xs = [], ys = []; for (const [k, arr] of byOfficer) { xs.push(k); ys.push(arr); }
      const xExpanded = ys.map((arr,i)=>Array(arr.length).fill(xs[i])).flat(), yExpanded = ys.flat();
      Plotly.newPlot("durationBox", [{type:"box",x:xExpanded,y:yExpanded,marker:{color:"#f59e0b"}}],
        {margin:{l:50,r:10,t:10,b:100},xaxis:{automargin:true,tickangle:-30,title:"Officer"},yaxis:{title:"Duration (minutes)"},displayModeBar:false},{responsive:true});
    }
    function renderIssuesBar(list) {
      const freq = new Map();
      for (const r of list) tokenizeIssues(r.observations).forEach(w=>freq.set(w,(freq.get(w)||0)+1));
      const data = Array.from(freq, ([k,v])=>({k,v})).sort((a,b)=>b.v-a.v).slice(0, 20);
      Plotly.newPlot("issuesBar", [{type:"bar",x:data.map(d=>d.k),y:data.map(d=>d.v),marker:{color:"#ef4444"}}],
        {margin:{l:40,r:10,t:10,b:100},xaxis:{automargin:true,tickangle:-30,title:"Frequent terms in observations"},yaxis:{title:"Frequency"},displayModeBar:false}, {responsive:true});
    }
    function renderTrendLine(list) {
      const byDay = new Map();
      for (const r of list) {
        if (!r.start) continue;
        const d = new Date(r.start.getFullYear(), r.start.getMonth(), r.start.getDate());
        const key = d.toISOString().slice(0,10);
        if (!byDay.has(key)) byDay.set(key, {visits:0, follow:0});
        const obj = byDay.get(key);
        obj.visits += 1;
        if (r.followup && r.followup.trim().length > 0) obj.follow += 1;
      }
      const days = Array.from(byDay.keys()).sort(), visits = days.map(k=>byDay.get(k).visits), follows = days.map(k=>byDay.get(k).follow);
      Plotly.newPlot("trendLine",[
        {type:"scatter",mode:"lines+markers",x:days,y:visits,name:"Visits",line:{color:"#2563eb"}},
        {type:"scatter",mode:"lines+markers",x:days,y:follows,name:"Follow-ups",line:{color:"#16a34a"}}
      ],{margin:{l:50,r:10,t:10,b:50},xaxis:{title:"Date"},yaxis:{title:"Count"},legend:{orientation:"h"},displayModeBar:false},{responsive:true});
    }
    function renderMap(list) {
      const points = list.filter(r=>r.lat!=null&&r.lon!=null);
      const unknown = list.filter(r=>r.lat==null || r.lon==null);
      const hover = points.map(r=>`Officer: ${r.officer||"-"}<br>Dept: ${r.department||"-"}<br>Mandal: ${r.mandal||"-"}<br>Panchayat: ${r.panchayat||"-"}<br>Purpose: ${r.purpose||"-"}<br>Start: ${r.start?r.start.toLocaleString():"-"}`);
      const traces = [];
      if (points.length) traces.push({type:"scattermapbox",lat:points.map(r=>r.lat),lon:points.map(r=>r.lon),mode:"markers",text:hover,hoverinfo:"text",marker:{size:10,color:"#e11d48",opacity:0.8}});
      const annotations = [];
      if (unknown.length) annotations.push({text:`Note: ${unknown.length} records lack Lat/Lon`,showarrow:false,xref:"paper",yref:"paper",x:0,y:1.12,font:{size:11,color:"#6b7280"}});
      Plotly.newPlot("map",traces,{margin:{l:0,r:0,t:20,b:0},mapbox:{style:"open-street-map",center:points.length?{lat:points[0].lat,lon:points.lon}:{lat:18.036,lon:78.265}, zoom:8},annotations},{responsive:true});
    }
    function renderAll() {
      updateKPIs(filtered);
      renderMap(filtered);
      renderOfficerBar(filtered);
      renderDeptBar(filtered);
      renderPurposePie(filtered);
      renderDurationBox(filtered);
      renderIssuesBar(filtered);
      renderTrendLine(filtered);
    }
    function attachEvents() {
      document.getElementById("applyBtn").addEventListener("click", applyFilters);
      document.getElementById("resetBtn").addEventListener("click", resetFilters);
      window.addEventListener("resize", ()=>renderAll());
    }
    // Initialization
    async function init() {
      rows = normalize(await fetchSheet());
      filtered = rows.slice();
      populateFilters(rows);
      attachEvents();
      renderAll();
    }
    init();
  </script>
</body>
</html>
