<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Medak Officers’ Performance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Plotly and SheetJS CDN -->
  <script src="https://cdn.plot.ly/plotly-2.35.3.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
  body { font-family: system-ui, Segoe UI, Arial, sans-serif; margin: 0; background: #f7f8fa; color: #111; }
  header { background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: #fff; padding: 16px 20px; }
  .container { padding: 18px; max-width: 1400px; margin: 0 auto; }
  .filters { display: grid; gap: 13px; grid-template-columns: repeat(7, minmax(160px, 1fr)); background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; position: sticky; top: 0; z-index: 2;}
  .filters label { font-size: 13px; color: #374151; margin-bottom: 3.5px; display: block; }
  .filters input, .filters select { width: 100%; padding: 8px; font-size: 13px; border: 1px solid #d1d5db; border-radius: 8px;}
  .buttons { display: flex; gap: 7px; align-items: flex-end; }
  button { padding: 8px 16px; border-radius: 8px; border: none; font-size: 14px; cursor: pointer; background: #2563eb; color: #fff;}
  button.secondary { background: #6b7280; }
  .export-dropdown { padding: 8px 12px; border-radius: 8px; font-size: 13px; border: 1px solid #d1d5db;}
  .kpis { display: grid; gap: 12px; grid-template-columns: repeat(5, 1fr); margin-top: 16px; }
  .kpi { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px;}
  .kpi .label { font-size: 12px; color: #6b7280; }
  .kpi .value { font-size: 22px; font-weight: 700; margin-top: 7px; }
  .grid { display: grid; gap: 18px; grid-template-columns: 1fr 1fr; margin-top: 18px;}
  .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px;}
  .card h3 { margin: 0 0 13px; font-size: 16px; }
  .footer { color: #6b7280; font-size: 12px; text-align: center; padding: 17px;}
  .recent-tours { margin-top: 32px;}
  .recent-tours-header { font-weight: bold; font-size: 18px; margin-bottom: 9px; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 24px;}
  th, td { border: 1px solid #e5e7eb; padding: 7px 9px; text-align: left; font-size: 13px;}
  th { background: #f3f4f6; cursor: pointer;}
  tr:nth-child(even) { background: #fafbfc;}
  tr:hover { background: #e5e7eb; }
  @media (max-width: 1000px) {
    .filters { grid-template-columns: repeat(1, minmax(160px, 1fr)); }
    .kpis { grid-template-columns: repeat(2, 1fr);}
    .grid { grid-template-columns: 1fr;}
  }
  </style>
</head>
<body>
  <header>
    <h1>Medak District Officers’ Performance Dashboard</h1>
    <p>Interactive analytics and exports. Latest mapping, purpose and coverage metrics, and recent tours table.</p>
  </header>
  <div class="container">
    <div class="filters">
      <div>
        <label for="department">Department</label>
        <select id="department"><option value="">All</option></select>
      </div>
      <div>
        <label for="officer">Officer</label>
        <select id="officer"><option value="">All</option></select>
      </div>
      <div>
        <label for="mandal">Mandal</label>
        <select id="mandal"><option value="">All</option></select>
      </div>
      <div>
        <label for="panchayat">Panchayat</label>
        <select id="panchayat"><option value="">All</option></select>
      </div>
      <div>
        <label for="purpose">Purpose</label>
        <select id="purpose"><option value="">All</option></select>
      </div>
      <div>
        <label for="attachment">Attachment</label>
        <select id="attachment">
          <option value="">All</option>
          <option value="has">Has attachment</option>
          <option value="none">No attachment</option>
        </select>
      </div>
      <div>
        <label for="fromDate">From Date</label><input type="date" id="fromDate" />
      </div>
      <div>
        <label for="toDate">To Date</label><input type="date" id="toDate" />
      </div>
      <div class="buttons">
        <button id="applyBtn">Apply</button>
        <button id="resetBtn" class="secondary">Reset</button>
        <select id="exportType" class="export-dropdown">
          <option value="">Export</option>
          <option value="xlsx">Export XLSX</option>
          <option value="csv">Export CSV</option>
          <option value="json">Export JSON</option>
        </select>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="label">Total Tours</div><div class="value" id="kpiTotal">-</div></div>
      <div class="kpi"><div class="label">Avg Duration</div><div class="value" id="kpiAvgDur">-</div></div>
      <div class="kpi"><div class="label">% With Attachments</div><div class="value" id="kpiAttach">-</div></div>
      <div class="kpi"><div class="label">Distinct Panchayats</div><div class="value" id="kpiPanch">-</div></div>
      <div class="kpi"><div class="label">Distinct Mandals</div><div class="value" id="kpiMandal">-</div></div>
    </div>
    <div class="grid">
      <div class="card" style="height:520px;">
        <h3>Mandal Coverage (No. of Tours)</h3>
        <div id="mandalCoverage" style="width:100%;height:460px;"></div>
      </div>
      <div class="card" style="height:520px;">
        <h3>Purpose of Visits</h3>
        <div id="purposePie" style="width:100%;height:460px;"></div>
      </div>
    </div>
    <div class="recent-tours">
      <div class="recent-tours-header">Recent Tours (Latest 50)</div>
      <div id="recentTours"></div>
    </div>
    <div class="footer">
      GitHub Pages hosting. Last refreshed <span id="lastRefreshed">-</span>.
    </div>
  </div>
  <script>
    // --- Sheet API CONFIG ---
    const SHEET_ID = "1JTtApnz0YUBocOEsVaPeNgtegO8A2fJoJqRDh38UHgo";
    const API_KEY = "AIzaSyANuZBwPyDawHhfzA2uXvWZH2k6b38mzXM";
    const TAB_NAME = "Form Responses 1";
    const RANGE = `${TAB_NAME}!A1:AZ100000`;
    const FIELDS = {
      timestamp: ["Timestamp"], email: ["Email Address","Email"], officer: ["Name of the Officer","Officer Name","Officer"],
      department: ["Department"], designation: ["Designation"], contact: ["Contact Number","Phone","Mobile"],
      start: ["Tour Start Date & Time","Start","Start Time"], end: ["Tour End Date & Time","End","End Time"],
      mandal: ["Mandal Name","Mandal"], panchayat: ["Panchayat Name","Panchayat"], purpose: ["Purpose of Visit","Purpose"],
      observations: ["Key observations/Outcomes","Observations","Outcomes","Findings"], followup: ["Follow-up Actions Required","Follow up","Follow-up"],
      hierarchy: ["Level of hierarchy","Hierarchy"], attachments: ["Attachments","Attachment","Photo URL"], lat: ["Latitude","Lat"], lon: ["Longitude","Lon","Lng"]
    };
    function parseDateFlexible(s) {
      if (!s) return null;
      const tryDate = new Date(s);
      if (!isNaN(tryDate)) return tryDate;
      const t = String(s).trim().replace(/\./g, ":").replace(/\//g, "-");
      let m = t.match(/^(\d{1,2})-(\d{1,2})-(\d{4})\s+(\d{1,2}):(\d{2})$/);
      if (m) { const [, d, mo, y, hh, mm] = m; return new Date(Number(y), Number(mo)-1, Number(d), Number(hh), Number(mm)); }
      m = t.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
      if (m) { const [, d, mo, y] = m; return new Date(Number(y), Number(mo)-1, Number(d)); }
      return null;
    }
    function minutesBetween(a, b) { return !a || !b ? null : Math.round((b-a)/60000); }
    function pick(obj, keysArr) { for (const k of keysArr) { if (obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k]; } return ""; }
    function toSet(arr) { return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b))); }
    let rows = [], filtered = [];
    // --- GET AND NORMALIZE DATA ---
    async function fetchSheet() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(RANGE)}?key=${API_KEY}`;
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status} on "${RANGE}"`);
        const data = await res.json();
        const values = data.values || [];
        if (values.length < 2) return [];
        const headers = values[0].map(h => (h || "").trim());
        return values.slice(1).map(r => {
          const obj = {}; headers.forEach((h, i) => obj[h] = (r[i] ?? "").trim());
          return obj;
        });
      } catch (err) {
        alert("Google Sheets fetch failed. Check sharing, tab name, API key. Details: " + err);
        return [];
      }
    }
    function normalize(records) {
      return records.map(r => {
        const rec = {
          timestamp: pick(r, FIELDS.timestamp),
          email: pick(r, FIELDS.email),
          officer: pick(r, FIELDS.officer),
          department: pick(r, FIELDS.department),
          designation: pick(r, FIELDS.designation),
          contact: pick(r, FIELDS.contact),
          startRaw: pick(r, FIELDS.start),
          endRaw: pick(r, FIELDS.end),
          mandal: pick(r, FIELDS.mandal),
          panchayat: pick(r, FIELDS.panchayat),
          purpose: pick(r, FIELDS.purpose),
          observations: pick(r, FIELDS.observations),
          followup: pick(r, FIELDS.followup),
          hierarchy: pick(r, FIELDS.hierarchy),
          attachments: pick(r, FIELDS.attachments),
          lat: pick(r, FIELDS.lat),
          lon: pick(r, FIELDS.lon)
        };
        rec.start = parseDateFlexible(rec.startRaw);
        rec.end = parseDateFlexible(rec.endRaw);
        rec.durationMin = minutesBetween(rec.start, rec.end);
        rec.hasAttachment = !!(rec.attachments && rec.attachments.length > 0);
        rec.lat = (rec.lat && !isNaN(Number(rec.lat))) ? Number(rec.lat) : null;
        rec.lon = (rec.lon && !isNaN(Number(rec.lon))) ? Number(rec.lon) : null;
        return rec;
      });
    }
    // --- FILTERS ---
    function populateFilters(list) {
      function fillSelect(el, arr) {
        let selected = el.value;
        el.innerHTML = '<option value="">All</option>';
        toSet(arr).forEach(v => { const opt = document.createElement("option"); opt.value = v; opt.textContent = v; el.appendChild(opt); });
        if (selected) el.value = selected;
      }
      fillSelect(document.getElementById("department"), list.map(x => x.department));
      fillSelect(document.getElementById("officer"), list.map(x => x.officer));
      fillSelect(document.getElementById("mandal"), list.map(x => x.mandal));
      fillSelect(document.getElementById("panchayat"), list.map(x => x.panchayat));
      fillSelect(document.getElementById("purpose"), list.map(x => x.purpose));
      // Fill date fields
      const starts = list.map(x => x.start).filter(Boolean).sort((a,b)=>a-b);
      if (starts.length) { document.getElementById("fromDate").valueAsDate = starts[0]; document.getElementById("toDate").valueAsDate = starts[starts.length-1]; }
    }
    function applyFilters() {
      const department = document.getElementById("department").value;
      const officer = document.getElementById("officer").value;
      const mandal = document.getElementById("mandal").value;
      const panchayat = document.getElementById("panchayat").value;
      const purpose = document.getElementById("purpose").value;
      const attachment = document.getElementById("attachment").value;
      const fromDate = document.getElementById("fromDate").value ? new Date(document.getElementById("fromDate").value) : null;
      const toDate = document.getElementById("toDate").value ? new Date(document.getElementById("toDate").value) : null;
      if (toDate) toDate.setHours(23,59,59,999);
      filtered = rows.filter(r => {
        if (department && r.department !== department) return false;
        if (officer && r.officer !== officer) return false;
        if (mandal && r.mandal !== mandal) return false;
        if (panchayat && r.panchayat !== panchayat) return false;
        if (purpose && r.purpose !== purpose) return false;
        if (attachment === "has" && !r.hasAttachment) return false;
        if (attachment === "none" && r.hasAttachment) return false;
        if (fromDate && r.start && r.start < fromDate) return false;
        if (toDate && r.start && r.start > toDate) return false;
        return true;
      });
      renderAll();
    }
    function resetFilters() {
      ["department","officer","mandal","panchayat","purpose","attachment"].forEach(id => document.getElementById(id).value = "");
      document.getElementById("fromDate").value = "";
      document.getElementById("toDate").value = "";
      filtered = rows.slice();
      renderAll();
    }
    // --- EXPORT ---
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("exportType").addEventListener("change", function() {
        const val = this.value;
        if (!val) return;
        const data = filtered.map(x => ({
          "Timestamp": x.timestamp,
          "Officer": x.officer,
          "Department": x.department,
          "Designation": x.designation,
          "Contact Number": x.contact,
          "Start": x.startRaw,
          "End": x.endRaw,
          "Mandal": x.mandal,
          "Panchayat": x.panchayat,
          "Purpose": x.purpose,
          "Observations/Outcomes": x.observations,
          "Follow-up": x.followup,
          "Attachment": x.attachments
        }));
        if (val === "xlsx") {
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.json_to_sheet(data);
          XLSX.utils.book_append_sheet(wb, ws, "Tours");
          XLSX.writeFile(wb, "medak_tours.xlsx");
        } else if (val === "csv") {
          const ws = XLSX.utils.json_to_sheet(data);
          XLSX.writeFile({SheetNames:["Tours"],Sheets:{Tours:ws}}, "medak_tours.csv", {bookType:"csv"});
        } else if (val === "json") {
          const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "medak_tours.json";
          a.click();
        }
        this.value = "";
      });
    });
    // --- KPIS & CHARTS ---
    function fmtMins(min) { if (min == null || isNaN(min)) return "-"; const h = Math.floor(min/60), m = min%60; return h>0 ?`${h}h ${m}m`:`${m}m`; }
    function updateKPIs(list) {
      const total = list.length;
      const durationVals = list.map(x => x.durationMin || 0).filter(x=>x>0);
      const avg = durationVals.length ? Math.round(durationVals.reduce((a,b)=>a+b,0) / durationVals.length) : 0;
      const withAttach = list.filter(x => x.hasAttachment).length;
      const panch = toSet(list.map(x => x.panchayat)).length;
      const mandal = toSet(list.map(x => x.mandal)).length;
      document.getElementById("kpiTotal").textContent = total.toLocaleString();
      document.getElementById("kpiAvgDur").textContent = fmtMins(avg);
      document.getElementById("kpiAttach").textContent = (total ? Math.round(100*withAttach/total) : 0) + "%";
      document.getElementById("kpiPanch").textContent = panch.toLocaleString();
      document.getElementById("kpiMandal").textContent = mandal.toLocaleString();
      document.getElementById("lastRefreshed").textContent = new Date().toLocaleString();
    }
    function groupCount(list, key) {
      const map = new Map();
      for (const r of list) { const k = (r[key] || "Unknown"); map.set(k, (map.get(k)||0)+1); }
      return Array.from(map, ([k,v]) => ({k,v})).sort((a,b)=>b.v-a.v);
    }
    function renderMandalCoverage(list) {
      const data = groupCount(list, "mandal").slice(0, 30);
      Plotly.newPlot("mandalCoverage", [{
        type:"bar",
        x: data.map(d=>d.v),
        y: data.map(d=>d.k),
        orientation: "h",
        marker: { color: "#10b981" }
      }], {
        margin:{l:90,r:20,t:10,b:40},
        xaxis:{title:"No. of Tours", tickmode:"linear", dtick:1, tickformat:',d'},
        yaxis:{title:"Mandal", automargin:true},
        displayModeBar:false
      }, {responsive:true});
    }
    function renderPurposePie(list) {
      const data = groupCount(list, "purpose");
      Plotly.newPlot("purposePie", [{
        type:"pie",
        labels: data.map(d=>d.k),
        values: data.map(d=>d.v),
        textinfo:"label+percent",
        hole:0.45,
        marker: { colors:["#ffbe0b","#fb5607","#8338ec","#3a86ff","#ff006e","#00f5d4","#43aa8b","#870603","#e9ff70","#33415c","#dc6bad","#f6d743","#4f772d"] }
      }], {
        margin:{l:10,r:10,t:10,b:10},
        showlegend:true,
        displayModeBar:false
      }, {responsive:true});
    }
    // --- RECENT TOURS TABLE ---
    function renderRecentToursTable(list) {
      const container = document.getElementById("recentTours");
      if (!list.length) { container.innerHTML = "<i>No tours found.</i>"; return; }
      const cols = [
        { k:"timestamp", label:"Date" },{k:"officer",label:"Officer"},{k:"department",label:"Dept"},
        {k:"designation",label:"Desig."},{k:"mandal",label:"Mandal"},{k:"panchayat",label:"Panchayat"},
        {k:"purpose",label:"Purpose"},{k:"observations",label:"Key Observations"},{k:"followup",label:"Follow-up"}
      ];
      const header = `<tr>${cols.map(c=>`<th>${c.label}</th>`).join("")}</tr>`;
      const rowsHtml = list.slice(0,50).map(r=>
        `<tr>${cols.map(c=>`<td>${r[c.k]?r[c.k]:""}</td>`).join("")}</tr>`
      ).join("");
      container.innerHTML = `<table>${header}${rowsHtml}</table>`;
    }
    function renderAll() {
      updateKPIs(filtered);
      renderMandalCoverage(filtered);
      renderPurposePie(filtered);
      renderRecentToursTable(filtered.sort((a,b)=>b.start-b.start));
    }
    function attachEvents() {
      document.getElementById("applyBtn").addEventListener("click", applyFilters);
      document.getElementById("resetBtn").addEventListener("click", resetFilters);
      window.addEventListener("resize", ()=>renderAll());
    }
    // --- INIT ---
    async function init() {
      rows = normalize(await fetchSheet());
      filtered = rows.slice();
      populateFilters(rows);
      attachEvents();
      renderAll();
    }
    init();
  </script>
</body>
</html>
